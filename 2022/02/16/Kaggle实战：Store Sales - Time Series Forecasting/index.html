<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Kaggle实战：Store Sales - Time Series Forecasting | AndrewLee</title><meta name="keywords" content="Kaggle"><meta name="author" content="AndrewLee"><meta name="copyright" content="AndrewLee"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="（菜鸡梦呓，大佬轻喷） 数据浏览 train.csvThe training data, comprising time series of features store_nbr, family, and onpromotion as well as the target sales.  store_nbr identifies the store at which the products ar">
<meta property="og:type" content="article">
<meta property="og:title" content="Kaggle实战：Store Sales - Time Series Forecasting">
<meta property="og:url" content="http://example.com/2022/02/16/Kaggle%E5%AE%9E%E6%88%98%EF%BC%9AStore%20Sales%20-%20Time%20Series%20Forecasting/index.html">
<meta property="og:site_name" content="AndrewLee">
<meta property="og:description" content="（菜鸡梦呓，大佬轻喷） 数据浏览 train.csvThe training data, comprising time series of features store_nbr, family, and onpromotion as well as the target sales.  store_nbr identifies the store at which the products ar">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/kaggle.jpg">
<meta property="article:published_time" content="2022-02-16T04:43:35.000Z">
<meta property="article:modified_time" content="2022-02-16T05:18:09.827Z">
<meta property="article:author" content="AndrewLee">
<meta property="article:tag" content="Kaggle">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/img/kaggle.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2022/02/16/Kaggle%E5%AE%9E%E6%88%98%EF%BC%9AStore%20Sales%20-%20Time%20Series%20Forecasting/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Kaggle实战：Store Sales - Time Series Forecasting',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-02-16 13:18:09'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    })(window)</script><meta name="generator" content="Hexo 5.4.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/img/tit.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">33</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">24</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">21</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> categories</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> others</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></li><li><a class="site-page child" href="/about/"><i class="fa-fw fas fa-heart"></i><span> about</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/kaggle.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">AndrewLee</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> categories</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> others</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></li><li><a class="site-page child" href="/about/"><i class="fa-fw fas fa-heart"></i><span> about</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Kaggle实战：Store Sales - Time Series Forecasting</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-02-16T04:43:35.000Z" title="发表于 2022-02-16 12:43:35">2022-02-16</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-02-16T05:18:09.827Z" title="更新于 2022-02-16 13:18:09">2022-02-16</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">学习笔记</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/IT/">IT</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">2.1k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>10分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Kaggle实战：Store Sales - Time Series Forecasting"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>（菜鸡梦呓，大佬轻喷）</p>
<h1 id="数据浏览"><a href="#数据浏览" class="headerlink" title="数据浏览"></a>数据浏览</h1><p><img src="https://img-blog.csdnimg.cn/981a431061094f56adf3d278b6a705f4.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW5kcmV3TWU4MjEx,size_10,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<h2 id="train-csv"><a href="#train-csv" class="headerlink" title="train.csv"></a>train.csv</h2><p>The training data, comprising time series of features store_nbr, family, and onpromotion as well as the target sales.</p>
<ul>
<li>store_nbr identifies the store at which the products are sold.</li>
<li>family identifies the type of product sold.</li>
<li>sales gives the total sales for a product family at a particular store at a given date. Fractional values are possible since products can be sold in fractional units (1.5 kg of cheese, for instance, as opposed to 1 bag of chips).</li>
<li>onpromotion gives the total number of items in a product family that were being promoted at a store at a given date.</li>
</ul>
<h2 id="test-csv"><a href="#test-csv" class="headerlink" title="test.csv"></a>test.csv</h2><p>The test data, having the same features as the training data. You will predict the target sales for the dates in this file.</p>
<p>The dates in the test data are for the 15 days after the last date in the training data.</p>
<h2 id="sample-submission-csv"><a href="#sample-submission-csv" class="headerlink" title="sample_submission.csv"></a>sample_submission.csv</h2><p>A sample submission file in the correct format.</p>
<h2 id="stores-csv"><a href="#stores-csv" class="headerlink" title="stores.csv"></a>stores.csv</h2><p>Store metadata, including city, state, type, and cluster.</p>
<p>cluster is a grouping of similar stores.</p>
<h2 id="oil-csv"><a href="#oil-csv" class="headerlink" title="oil.csv"></a>oil.csv</h2><p>Daily oil price. Includes values during both the train and test data timeframes. (Ecuador is an oil-dependent country and it’s economical health is highly vulnerable to shocks in oil prices.)</p>
<h2 id="holidays-events-csv"><a href="#holidays-events-csv" class="headerlink" title="holidays_events.csv"></a>holidays_events.csv</h2><p> Holidays and Events, with metadata</p>
<ul>
<li>NOTE: Pay special attention to the transferred column. A holiday that is transferred officially falls on that calendar day, but was moved to another date by the government. A transferred day is more like a normal day than a holiday. To find the day that it was actually celebrated, look for the corresponding row where type is Transfer. For example, the holiday Independencia de Guayaquil was transferred from 2012-10-09 to 2012-10-12, which means it was celebrated on 2012-10-12. Days that are type Bridge are extra days that are added to a holiday (e.g., to extend the break across a long weekend). These are frequently made up by the type Work Day which is a day not normally scheduled for work (e.g., Saturday) that is meant to payback the Bridge.</li>
<li>Additional holidays are days added a regular calendar holiday, for example, as typically happens around Christmas (making Christmas Eve a holiday).</li>
</ul>
<h2 id="Additional-Notes"><a href="#Additional-Notes" class="headerlink" title="Additional Notes"></a>Additional Notes</h2><ul>
<li>Wages in the public sector are paid every two weeks on the 15 th and on the last day of the month. Supermarket sales could be affected by this.</li>
<li>A magnitude 7.8 earthquake struck Ecuador on April 16, 2016. People rallied in relief efforts donating water and other first need products which greatly affected supermarket sales for several weeks after the earthquake.</li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>稍微总结一下，现有的可用数据如下：</p>
<h3 id="在train-csv中"><a href="#在train-csv中" class="headerlink" title="在train.csv中"></a>在train.csv中</h3><p>每一个货物有这些特征：</p>
<ul>
<li><p>store_nbr：所在商店</p>
</li>
<li><p>family：所属商品类型</p>
</li>
<li><p>sales：所属商品类型在货物所在商店当日的销售额</p>
</li>
<li><p>onpromotion：所属商品类型在货物所在商店当日的进货数量</p>
<h3 id="在stores-csv中"><a href="#在stores-csv中" class="headerlink" title="在stores.csv中"></a>在stores.csv中</h3><p>每一个商店有如下特征：</p>
</li>
<li><p>city：所在城市</p>
</li>
<li><p>state：所在州</p>
</li>
<li><p>type：类型</p>
</li>
<li><p>cluster：聚类，也就是一群类似的商店抱的团（只不过不知道哪里类似……）</p>
</li>
</ul>
<h3 id="在oil-csv中"><a href="#在oil-csv中" class="headerlink" title="在oil.csv中"></a>在oil.csv中</h3><p>每天的油价dcoilwtico</p>
<h3 id="在holidays-events-csv中"><a href="#在holidays-events-csv中" class="headerlink" title="在holidays_events.csv中"></a>在holidays_events.csv中</h3><ul>
<li>date：日期</li>
<li>type：类型，包括节假日holiday，时间Event等等</li>
<li>locale：事件范围，全国的，本地的等等</li>
<li>locale_name：事件范围的地点，如果是国家性的就对应厄瓜多尔，如果是某个地方的节日就对应某个地方</li>
<li>description：描述，也就是节日的名字</li>
<li>transferred：是否是推迟后的节日。如果是推迟后的，那么就没那么重要了</li>
</ul>
<h3 id="在transactions-csv中"><a href="#在transactions-csv中" class="headerlink" title="在transactions.csv中"></a>在transactions.csv中</h3><p>就是每天的交易额</p>
<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><ul>
<li><p>test.csv：训练好模型后就用这里面的数据来求答案了</p>
</li>
<li><p>sample_submission.csv：一个答案的格式示例</p>
</li>
</ul>
<h1 id="数据清洗和特征工程"><a href="#数据清洗和特征工程" class="headerlink" title="数据清洗和特征工程"></a>数据清洗和特征工程</h1><p>先读入数据：</p>
<pre class="line-numbers language-py" data-language="py"><code class="language-py"><span class="token keyword">def</span> <span class="token function">ReadInData</span><span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    path <span class="token operator">=</span> <span class="token string">'store-sales-time-series-forecasting/'</span>
    <span class="token keyword">return</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>path <span class="token operator">+</span> <span class="token builtin">file</span><span class="token punctuation">)</span>

df_holidays_events <span class="token operator">=</span> ReadInData<span class="token punctuation">(</span><span class="token string">'holidays_events.csv'</span><span class="token punctuation">)</span>
df_oil <span class="token operator">=</span> ReadInData<span class="token punctuation">(</span><span class="token string">'oil.csv'</span><span class="token punctuation">)</span>
df_stores <span class="token operator">=</span> ReadInData<span class="token punctuation">(</span><span class="token string">'stores.csv'</span><span class="token punctuation">)</span>
df_train <span class="token operator">=</span> ReadInData<span class="token punctuation">(</span><span class="token string">'train.csv'</span><span class="token punctuation">)</span>
df_test <span class="token operator">=</span> ReadInData<span class="token punctuation">(</span><span class="token string">"test.csv"</span><span class="token punctuation">)</span>
df_transactions <span class="token operator">=</span> ReadInData<span class="token punctuation">(</span><span class="token string">'transactions.csv'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="缺失值处理"><a href="#缺失值处理" class="headerlink" title="缺失值处理"></a>缺失值处理</h2><p>oil.csv中dcoilwtico属性下有一部分缺失值，观察油价图形:</p>
<pre class="line-numbers language-py" data-language="py"><code class="language-py"><span class="token keyword">def</span> <span class="token function">DrawLine</span><span class="token punctuation">(</span>X_data<span class="token punctuation">,</span> Y_data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    fig <span class="token operator">=</span> plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span><span class="token punctuation">)</span>
    axes <span class="token operator">=</span> fig<span class="token punctuation">.</span>add_subplot<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    axes<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>X_data<span class="token punctuation">,</span> Y_data<span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
DrawLine<span class="token punctuation">(</span>df_oil<span class="token punctuation">[</span><span class="token string">'date'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> df_oil<span class="token punctuation">[</span><span class="token string">'dcoilwtico'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>发现油价变动较大<br><img src="https://img-blog.csdnimg.cn/9d8a1029a99c44ffbfe3110b5201b217.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW5kcmV3TWU4MjEx,size_16,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>因此使用平均值来填充意义不大，因此使用前一个数据填充:</p>
<pre class="line-numbers language-py" data-language="py"><code class="language-py">df_oil_withoutNA <span class="token operator">=</span> df_oil<span class="token punctuation">.</span>fillna<span class="token punctuation">(</span>method<span class="token operator">=</span><span class="token string">"pad"</span><span class="token punctuation">)</span>
DrawLine<span class="token punctuation">(</span>df_oil_withoutNA<span class="token punctuation">[</span><span class="token string">'date'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> df_oil_withoutNA<span class="token punctuation">[</span><span class="token string">'dcoilwtico'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="https://img-blog.csdnimg.cn/84134744ba7d4af6943cbd0f80195d19.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW5kcmV3TWU4MjEx,size_17,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<h2 id="特征整合"><a href="#特征整合" class="headerlink" title="特征整合"></a>特征整合</h2><p>观察发现在其他的文件里面有一些可以整合到训练集(train.csv)和测试集(test.csv)里面的特征:</p>
<ul>
<li>stores.csv中的city，state，type，cluster</li>
<li>oil.csv中的dcoilwtico</li>
<li>holidays_events.csv中的locale，locale_name，description，transferred</li>
<li>transaction中的交易额</li>
</ul>
<p>因此先对其他文件里面的索引重命名，然后使用merge函数对其进行合并操作：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">Add_Feature</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    df_holidays_events<span class="token punctuation">.</span>rename<span class="token punctuation">(</span>columns<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">'date'</span><span class="token punctuation">:</span> <span class="token string">'date'</span><span class="token punctuation">,</span>
                                       <span class="token string">'type'</span><span class="token punctuation">:</span> <span class="token string">'Daily_holiday_type'</span><span class="token punctuation">,</span>
                                       <span class="token string">'locale'</span><span class="token punctuation">:</span> <span class="token string">'Daily_holiday_locale'</span><span class="token punctuation">,</span>
                                       <span class="token string">'locale_name'</span><span class="token punctuation">:</span> <span class="token string">'Daily_holiday_locale_name'</span><span class="token punctuation">,</span>
                                       <span class="token string">'description'</span><span class="token punctuation">:</span> <span class="token string">"Daily_holiday_description"</span><span class="token punctuation">,</span>
                                       <span class="token string">'transferred'</span><span class="token punctuation">:</span> <span class="token string">"Daily_holiday_transferred"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
                              inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    df_stores<span class="token punctuation">.</span>rename<span class="token punctuation">(</span>columns<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">'store_nbr'</span><span class="token punctuation">:</span> <span class="token string">'store_nbr'</span><span class="token punctuation">,</span>
                              <span class="token string">'city'</span><span class="token punctuation">:</span> <span class="token string">'stores_city'</span><span class="token punctuation">,</span>
                              <span class="token string">'state'</span><span class="token punctuation">:</span> <span class="token string">'store_state'</span><span class="token punctuation">,</span>
                              <span class="token string">'type'</span><span class="token punctuation">:</span> <span class="token string">'store_type'</span><span class="token punctuation">,</span>
                              <span class="token string">'cluster'</span><span class="token punctuation">:</span> <span class="token string">'store_cluster'</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
                     inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    df_transactions<span class="token punctuation">.</span>rename<span class="token punctuation">(</span>columns<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">'transactions'</span><span class="token punctuation">:</span> <span class="token string">'Daily_transactions'</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    DfTrainNew <span class="token operator">=</span> pd<span class="token punctuation">.</span>merge<span class="token punctuation">(</span>df_train<span class="token punctuation">,</span> df_holidays_events<span class="token punctuation">,</span> how<span class="token operator">=</span><span class="token string">'left'</span><span class="token punctuation">,</span> left_on<span class="token operator">=</span><span class="token string">'date'</span><span class="token punctuation">,</span> right_on<span class="token operator">=</span><span class="token string">'date'</span><span class="token punctuation">)</span>
    DfTestNew <span class="token operator">=</span> pd<span class="token punctuation">.</span>merge<span class="token punctuation">(</span>df_test<span class="token punctuation">,</span> df_holidays_events<span class="token punctuation">,</span> how<span class="token operator">=</span><span class="token string">'left'</span><span class="token punctuation">,</span> left_on<span class="token operator">=</span><span class="token string">'date'</span><span class="token punctuation">,</span> right_on<span class="token operator">=</span><span class="token string">'date'</span><span class="token punctuation">)</span>
    DfTrainNew <span class="token operator">=</span> pd<span class="token punctuation">.</span>merge<span class="token punctuation">(</span>DfTrainNew<span class="token punctuation">,</span> df_oil_withoutNA<span class="token punctuation">,</span> how<span class="token operator">=</span><span class="token string">'left'</span><span class="token punctuation">,</span> left_on<span class="token operator">=</span><span class="token string">'date'</span><span class="token punctuation">,</span> right_on<span class="token operator">=</span><span class="token string">'date'</span><span class="token punctuation">)</span>
    DfTestNew <span class="token operator">=</span> pd<span class="token punctuation">.</span>merge<span class="token punctuation">(</span>DfTestNew<span class="token punctuation">,</span> df_oil_withoutNA<span class="token punctuation">,</span> how<span class="token operator">=</span><span class="token string">'left'</span><span class="token punctuation">,</span> left_on<span class="token operator">=</span><span class="token string">'date'</span><span class="token punctuation">,</span> right_on<span class="token operator">=</span><span class="token string">'date'</span><span class="token punctuation">)</span>
    DfTrainNew <span class="token operator">=</span> pd<span class="token punctuation">.</span>merge<span class="token punctuation">(</span>DfTrainNew<span class="token punctuation">,</span> df_stores<span class="token punctuation">,</span> how<span class="token operator">=</span><span class="token string">'left'</span><span class="token punctuation">,</span> left_on<span class="token operator">=</span><span class="token string">'store_nbr'</span><span class="token punctuation">,</span> right_on<span class="token operator">=</span><span class="token string">'store_nbr'</span><span class="token punctuation">)</span>
    DfTestNew <span class="token operator">=</span> pd<span class="token punctuation">.</span>merge<span class="token punctuation">(</span>DfTestNew<span class="token punctuation">,</span> df_stores<span class="token punctuation">,</span> how<span class="token operator">=</span><span class="token string">'left'</span><span class="token punctuation">,</span> left_on<span class="token operator">=</span><span class="token string">'store_nbr'</span><span class="token punctuation">,</span> right_on<span class="token operator">=</span><span class="token string">'store_nbr'</span><span class="token punctuation">)</span>
    DfTrainNew <span class="token operator">=</span> pd<span class="token punctuation">.</span>merge<span class="token punctuation">(</span>DfTrainNew<span class="token punctuation">,</span> df_transactions<span class="token punctuation">,</span> how<span class="token operator">=</span><span class="token string">'left'</span><span class="token punctuation">,</span> on<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'date'</span><span class="token punctuation">,</span> <span class="token string">'store_nbr'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    DfTestNew <span class="token operator">=</span> pd<span class="token punctuation">.</span>merge<span class="token punctuation">(</span>DfTestNew<span class="token punctuation">,</span> df_transactions<span class="token punctuation">,</span> how<span class="token operator">=</span><span class="token string">'left'</span><span class="token punctuation">,</span> on<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'date'</span><span class="token punctuation">,</span> <span class="token string">'store_nbr'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> DfTrainNew<span class="token punctuation">,</span> DfTestNew


res <span class="token operator">=</span> Add_Feature<span class="token punctuation">(</span><span class="token punctuation">)</span>
df_train_New <span class="token operator">=</span> res<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
df_test_New <span class="token operator">=</span> res<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>操作完后，统计一下非NA值的个数，来看看数据合并的效果：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">LookIn</span><span class="token punctuation">(</span>DF_In<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"length:&#123;&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>DF_In<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> DF_In<span class="token punctuation">.</span>columns<span class="token punctuation">:</span>
        a <span class="token operator">=</span> DF_In<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>describe<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Name:&#123;&#125; Rate:&#123;&#125;%"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">100</span> <span class="token operator">*</span> a<span class="token punctuation">[</span><span class="token string">'count'</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>DF_In<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"df_train_New:>>>>>>"</span><span class="token punctuation">)</span>
LookIn<span class="token punctuation">(</span>df_train_New<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"df_test_New:>>>>>>"</span><span class="token punctuation">)</span>
LookIn<span class="token punctuation">(</span>df_test_New<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"df_test:>>>>>>"</span><span class="token punctuation">)</span>
LookIn<span class="token punctuation">(</span>df_test<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>效果稍微有点出乎意料：</p>
<pre class="line-numbers language-none"><code class="language-none">df_train_New:&gt;&gt;&gt;&gt;&gt;&gt;
length:3054348
Name:id Rate:100.0%
Name:date Rate:100.0%
Name:store_nbr Rate:100.0%
Name:family Rate:100.0%
Name:sales Rate:100.0%
Name:onpromotion Rate:100.0%
Name:Daily_holiday_type Rate:16.45274212368728%
Name:Daily_holiday_locale Rate:16.45274212368728%
Name:Daily_holiday_locale_name Rate:16.45274212368728%
Name:Daily_holiday_description Rate:16.45274212368728%
Name:Daily_holiday_transferred Rate:16.45274212368728%
Name:dcoilwtico Rate:71.17852975495916%
Name:stores_city Rate:100.0%
Name:store_state Rate:100.0%
Name:store_type Rate:100.0%
Name:store_cluster Rate:100.0%
Name:transactions Rate:91.84385669216475%
df_test_New:&gt;&gt;&gt;&gt;&gt;&gt;
length:28512
Name:id Rate:100.0%
Name:date Rate:100.0%
Name:store_nbr Rate:100.0%
Name:family Rate:100.0%
Name:onpromotion Rate:100.0%
Name:Daily_holiday_type Rate:6.25%
Name:Daily_holiday_locale Rate:6.25%
Name:Daily_holiday_locale_name Rate:6.25%
Name:Daily_holiday_description Rate:6.25%
Name:Daily_holiday_transferred Rate:6.25%
Name:dcoilwtico Rate:75.0%
Name:stores_city Rate:100.0%
Name:store_state Rate:100.0%
Name:store_type Rate:100.0%
Name:store_cluster Rate:100.0%
Name:transactions Rate:0.0%
df_test:&gt;&gt;&gt;&gt;&gt;&gt;
length:28512
Name:id Rate:100.0%
Name:date Rate:100.0%
Name:store_nbr Rate:100.0%
Name:family Rate:100.0%
Name:onpromotion Rate:100.0%<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>不难发现，交易额合并后，测试集里面的所有样本都没有对应的销售额，因此销售额这个特征也许不应该这样用</p>
<p>之后看了看训练集数据后发现了一个更大的问题，就是经过增加特征后，训练集里面的样本数量变多了……花了一下午的时间才发现，原来同一天可以有很多节日……</p>
<p>很无语，只好暂时简单粗暴的去个重，有更好的办法就再说吧：</p>
<p><code>df_train_New.drop_duplicates(subset=&#39;id&#39;, keep=&#39;first&#39;, inplace=True)</code></p>
<p>当然还有一个问题，那就是大量的空缺值的问题。现阶段暂时先删掉这些东西：</p>
<p><code>df_train_New.dropna(axis=0, inplace=True)</code></p>
<p>下面也许可以先尝试一下建模，到时候再迭代修改就行</p>
<p>但是建模之前先要把数据映射一下，不然数据进不了机器学习模型的</p>
<h2 id="数据映射"><a href="#数据映射" class="headerlink" title="数据映射"></a>数据映射</h2><pre class="line-numbers language-py" data-language="py"><code class="language-py"><span class="token keyword">def</span> <span class="token function">PreWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    df_train_New<span class="token punctuation">.</span>dropna<span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    df_train_New<span class="token punctuation">.</span>drop_duplicates<span class="token punctuation">(</span>subset<span class="token operator">=</span><span class="token string">'id'</span><span class="token punctuation">,</span> keep<span class="token operator">=</span><span class="token string">'first'</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    df_train_New<span class="token punctuation">[</span><span class="token string">'date'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df_train_New<span class="token punctuation">[</span><span class="token string">'date'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> X<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>X<span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span>
                                                                    <span class="token builtin">str</span><span class="token punctuation">(</span>X<span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span>
                                                                    <span class="token builtin">str</span><span class="token punctuation">(</span>X<span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    df_train_New<span class="token punctuation">[</span><span class="token string">'family'</span><span class="token punctuation">]</span> <span class="token operator">=</span> pd<span class="token punctuation">.</span>factorize<span class="token punctuation">(</span>df_train_New<span class="token punctuation">[</span><span class="token string">'family'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span>
    df_train_New<span class="token punctuation">[</span><span class="token string">'Daily_holiday_type'</span><span class="token punctuation">]</span> <span class="token operator">=</span> pd<span class="token punctuation">.</span>factorize<span class="token punctuation">(</span>df_train_New<span class="token punctuation">[</span><span class="token string">'Daily_holiday_type'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span>
    df_train_New<span class="token punctuation">[</span><span class="token string">'Daily_holiday_locale'</span><span class="token punctuation">]</span> <span class="token operator">=</span> pd<span class="token punctuation">.</span>factorize<span class="token punctuation">(</span>df_train_New<span class="token punctuation">[</span><span class="token string">'Daily_holiday_locale'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span>
    df_train_New<span class="token punctuation">[</span><span class="token string">'Daily_holiday_locale_name'</span><span class="token punctuation">]</span> <span class="token operator">=</span> pd<span class="token punctuation">.</span>factorize<span class="token punctuation">(</span>df_train_New<span class="token punctuation">[</span><span class="token string">'Daily_holiday_locale_name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span>
    df_train_New<span class="token punctuation">[</span><span class="token string">'Daily_holiday_description'</span><span class="token punctuation">]</span> <span class="token operator">=</span> pd<span class="token punctuation">.</span>factorize<span class="token punctuation">(</span>df_train_New<span class="token punctuation">[</span><span class="token string">'Daily_holiday_description'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span>
    df_train_New<span class="token punctuation">[</span><span class="token string">'Daily_holiday_transferred'</span><span class="token punctuation">]</span> <span class="token operator">=</span> pd<span class="token punctuation">.</span>factorize<span class="token punctuation">(</span>df_train_New<span class="token punctuation">[</span><span class="token string">'Daily_holiday_transferred'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span>
    df_train_New<span class="token punctuation">[</span><span class="token string">'stores_city'</span><span class="token punctuation">]</span> <span class="token operator">=</span> pd<span class="token punctuation">.</span>factorize<span class="token punctuation">(</span>df_train_New<span class="token punctuation">[</span><span class="token string">'stores_city'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span>
    df_train_New<span class="token punctuation">[</span><span class="token string">'store_state'</span><span class="token punctuation">]</span> <span class="token operator">=</span> pd<span class="token punctuation">.</span>factorize<span class="token punctuation">(</span>df_train_New<span class="token punctuation">[</span><span class="token string">'store_state'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span>
    df_train_New<span class="token punctuation">[</span><span class="token string">'store_type'</span><span class="token punctuation">]</span> <span class="token operator">=</span> pd<span class="token punctuation">.</span>factorize<span class="token punctuation">(</span>df_train_New<span class="token punctuation">[</span><span class="token string">'store_type'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span>


PreWork<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="建模"><a href="#建模" class="headerlink" title="建模"></a>建模</h1><p>这个题给了每个商品很多特征，然后需要预测另外一些商品的价格。根据这个题的特点，发现可以先试一试决策树或者随机森林模型。至于题目里面说的时间序列预测……暂时还比较迷。</p>
<p>然后对训练集先用两个模型试试，然后使用MAE来评一下误差度：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">BuildDecisionTree</span><span class="token punctuation">(</span>x_F<span class="token punctuation">,</span> Y_F<span class="token punctuation">,</span> DataLog<span class="token punctuation">)</span><span class="token punctuation">:</span>
    x_ <span class="token operator">=</span> DataLog<span class="token punctuation">[</span>x_F<span class="token punctuation">]</span>
    Y_ <span class="token operator">=</span> DataLog<span class="token punctuation">[</span>Y_F<span class="token punctuation">]</span>
    model <span class="token operator">=</span> DecisionTreeRegressor<span class="token punctuation">(</span>random_state<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> max_depth<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">)</span>
    a_x<span class="token punctuation">,</span> b_x<span class="token punctuation">,</span> a_y<span class="token punctuation">,</span> b_y <span class="token operator">=</span> train_test_split<span class="token punctuation">(</span>x_<span class="token punctuation">,</span> Y_<span class="token punctuation">,</span> random_state<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
    model<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>a_x<span class="token punctuation">,</span> a_y<span class="token punctuation">)</span>
    predictions <span class="token operator">=</span> model<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>b_x<span class="token punctuation">)</span>
    delta <span class="token operator">=</span> mean_absolute_error<span class="token punctuation">(</span>b_y<span class="token punctuation">,</span> predictions<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"DecisionTree:mean_absolute_error delta:&#123;&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>delta<span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">BuildRandomForest</span><span class="token punctuation">(</span>x_F<span class="token punctuation">,</span> Y_F<span class="token punctuation">,</span> DataLog<span class="token punctuation">)</span><span class="token punctuation">:</span>
    x_ <span class="token operator">=</span> DataLog<span class="token punctuation">[</span>x_F<span class="token punctuation">]</span>
    Y_ <span class="token operator">=</span> DataLog<span class="token punctuation">[</span>Y_F<span class="token punctuation">]</span>
    model <span class="token operator">=</span> RandomForestRegressor<span class="token punctuation">(</span>random_state<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> max_depth<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">)</span>
    a_x<span class="token punctuation">,</span> b_x<span class="token punctuation">,</span> a_y<span class="token punctuation">,</span> b_y <span class="token operator">=</span> train_test_split<span class="token punctuation">(</span>x_<span class="token punctuation">,</span> Y_<span class="token punctuation">,</span> random_state<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
    model<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>a_x<span class="token punctuation">,</span> a_y<span class="token punctuation">)</span>
    predictions <span class="token operator">=</span> model<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>b_x<span class="token punctuation">)</span>
    delta <span class="token operator">=</span> mean_absolute_error<span class="token punctuation">(</span>b_y<span class="token punctuation">,</span> predictions<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"RandomForest:mean_absolute_error delta:&#123;&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>delta<span class="token punctuation">)</span><span class="token punctuation">)</span>

X_Feature <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token string">'date'</span><span class="token punctuation">,</span> <span class="token string">'store_nbr'</span><span class="token punctuation">,</span> <span class="token string">'family'</span><span class="token punctuation">,</span> <span class="token string">'onpromotion'</span><span class="token punctuation">,</span>
             <span class="token string">'Daily_holiday_type'</span><span class="token punctuation">,</span> <span class="token string">'Daily_holiday_locale'</span><span class="token punctuation">,</span>
             <span class="token string">'Daily_holiday_locale_name'</span><span class="token punctuation">,</span> <span class="token string">'Daily_holiday_description'</span><span class="token punctuation">,</span>
             <span class="token string">'Daily_holiday_transferred'</span><span class="token punctuation">,</span> <span class="token string">'dcoilwtico'</span><span class="token punctuation">,</span> <span class="token string">'stores_city'</span><span class="token punctuation">,</span> <span class="token string">'store_state'</span><span class="token punctuation">,</span>
             <span class="token string">'store_type'</span><span class="token punctuation">,</span> <span class="token string">'store_cluster'</span><span class="token punctuation">,</span> <span class="token string">'transactions'</span><span class="token punctuation">]</span>
Y_Feature <span class="token operator">=</span> <span class="token string">'sales'</span>
BuildRandomForest<span class="token punctuation">(</span>X_Feature<span class="token punctuation">,</span> Y_Feature<span class="token punctuation">,</span> df_train_New<span class="token punctuation">)</span>
BuildDecisionTree<span class="token punctuation">(</span>X_Feature<span class="token punctuation">,</span> Y_Feature<span class="token punctuation">,</span> df_train_New<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>当然随机森林不出意外的要精确一些：</p>
<pre class="line-numbers language-none"><code class="language-none">RandomForest:mean_absolute_error delta:73.51907510982585
DecisionTree:mean_absolute_error delta:97.08605686543322<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>于是尝试用随机森林模型来预测一下测试集</p>
<pre class="line-numbers language-py" data-language="py"><code class="language-py">
<span class="token keyword">def</span> <span class="token function">Forecast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    model <span class="token operator">=</span> RandomForestRegressor<span class="token punctuation">(</span>random_state<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> max_depth<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">)</span>
    model<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>df_train_New<span class="token punctuation">[</span>X_Feature<span class="token punctuation">]</span><span class="token punctuation">,</span> df_train_New<span class="token punctuation">[</span>Y_Feature<span class="token punctuation">]</span><span class="token punctuation">)</span>
    Aim <span class="token operator">=</span> df_test_New<span class="token punctuation">[</span>X_Feature<span class="token punctuation">]</span>
    predictions <span class="token operator">=</span> model<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>Aim<span class="token punctuation">)</span>
    res <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>predictions<span class="token punctuation">)</span>
    path <span class="token operator">=</span> <span class="token string">"store-sales-time-series-forecasting/submission.csv"</span>
    res<span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span>path<span class="token punctuation">)</span>


Forecast<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>然后把预测数据修改一下索引，放到kaggle上面去：</p>
<p><img src="https://img-blog.csdnimg.cn/3c3144c2361144178a09bb9e3b926104.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW5kcmV3TWU4MjEx,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>芜湖！</p>
<h1 id="To-Be-Continue："><a href="#To-Be-Continue：" class="headerlink" title="To Be Continue："></a>To Be Continue：</h1></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">AndrewLee</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2022/02/16/Kaggle%E5%AE%9E%E6%88%98%EF%BC%9AStore%20Sales%20-%20Time%20Series%20Forecasting/">http://example.com/2022/02/16/Kaggle%E5%AE%9E%E6%88%98%EF%BC%9AStore%20Sales%20-%20Time%20Series%20Forecasting/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">AndrewLee</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Kaggle/">Kaggle</a></div><div class="post_share"><div class="social-share" data-image="/img/kaggle.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/02/16/python%20pandas%E7%AC%94%E8%AE%B0/"><img class="prev-cover" src="/img/kaggle2.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">python pandas笔记</div></div></a></div><div class="next-post pull-right"><a href="/2021/11/14/CTF%E5%88%B7%E9%A2%98%E8%AE%B0/"><img class="next-cover" src="/img/ctf.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">CTF刷题记</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-info-avatar is-center"><img class="avatar-img" src="/img/tit.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">AndrewLee</div><div class="author-info__description">Gubba nub nub doo rahkah</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">33</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">24</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">21</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/Andrew82106" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="tencent://AddContact/?fromId=45&amp;fromSubId=1&amp;subcmd=all&amp;uin=281512383&amp;website=www.oicqzone.com" target="_blank" title="QQ"><i class="fab fa-qq"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E6%B5%8F%E8%A7%88"><span class="toc-number">1.</span> <span class="toc-text">数据浏览</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#train-csv"><span class="toc-number">1.1.</span> <span class="toc-text">train.csv</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#test-csv"><span class="toc-number">1.2.</span> <span class="toc-text">test.csv</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sample-submission-csv"><span class="toc-number">1.3.</span> <span class="toc-text">sample_submission.csv</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#stores-csv"><span class="toc-number">1.4.</span> <span class="toc-text">stores.csv</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#oil-csv"><span class="toc-number">1.5.</span> <span class="toc-text">oil.csv</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#holidays-events-csv"><span class="toc-number">1.6.</span> <span class="toc-text">holidays_events.csv</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Additional-Notes"><span class="toc-number">1.7.</span> <span class="toc-text">Additional Notes</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">1.8.</span> <span class="toc-text">总结</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8train-csv%E4%B8%AD"><span class="toc-number">1.8.1.</span> <span class="toc-text">在train.csv中</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8stores-csv%E4%B8%AD"><span class="toc-number">1.8.2.</span> <span class="toc-text">在stores.csv中</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8oil-csv%E4%B8%AD"><span class="toc-number">1.8.3.</span> <span class="toc-text">在oil.csv中</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8holidays-events-csv%E4%B8%AD"><span class="toc-number">1.8.4.</span> <span class="toc-text">在holidays_events.csv中</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8transactions-csv%E4%B8%AD"><span class="toc-number">1.8.5.</span> <span class="toc-text">在transactions.csv中</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B6%E4%BB%96"><span class="toc-number">1.8.6.</span> <span class="toc-text">其他</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E6%B8%85%E6%B4%97%E5%92%8C%E7%89%B9%E5%BE%81%E5%B7%A5%E7%A8%8B"><span class="toc-number">2.</span> <span class="toc-text">数据清洗和特征工程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%BA%E5%A4%B1%E5%80%BC%E5%A4%84%E7%90%86"><span class="toc-number">2.1.</span> <span class="toc-text">缺失值处理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%89%B9%E5%BE%81%E6%95%B4%E5%90%88"><span class="toc-number">2.2.</span> <span class="toc-text">特征整合</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E6%98%A0%E5%B0%84"><span class="toc-number">2.3.</span> <span class="toc-text">数据映射</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BB%BA%E6%A8%A1"><span class="toc-number">3.</span> <span class="toc-text">建模</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#To-Be-Continue%EF%BC%9A"><span class="toc-number">4.</span> <span class="toc-text">To Be Continue：</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2022/02/16/python%20%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" title="python 机器学习笔记"><img src="/img/sw.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="python 机器学习笔记"/></a><div class="content"><a class="title" href="/2022/02/16/python%20%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" title="python 机器学习笔记">python 机器学习笔记</a><time datetime="2022-02-16T05:16:35.000Z" title="发表于 2022-02-16 13:16:35">2022-02-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/02/16/python%20pandas%E7%AC%94%E8%AE%B0/" title="python pandas笔记"><img src="/img/kaggle2.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="python pandas笔记"/></a><div class="content"><a class="title" href="/2022/02/16/python%20pandas%E7%AC%94%E8%AE%B0/" title="python pandas笔记">python pandas笔记</a><time datetime="2022-02-16T05:11:35.000Z" title="发表于 2022-02-16 13:11:35">2022-02-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/02/16/Kaggle%E5%AE%9E%E6%88%98%EF%BC%9AStore%20Sales%20-%20Time%20Series%20Forecasting/" title="Kaggle实战：Store Sales - Time Series Forecasting"><img src="/img/kaggle.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Kaggle实战：Store Sales - Time Series Forecasting"/></a><div class="content"><a class="title" href="/2022/02/16/Kaggle%E5%AE%9E%E6%88%98%EF%BC%9AStore%20Sales%20-%20Time%20Series%20Forecasting/" title="Kaggle实战：Store Sales - Time Series Forecasting">Kaggle实战：Store Sales - Time Series Forecasting</a><time datetime="2022-02-16T04:43:35.000Z" title="发表于 2022-02-16 12:43:35">2022-02-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/11/14/CTF%E5%88%B7%E9%A2%98%E8%AE%B0/" title="CTF刷题记"><img src="/img/ctf.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="CTF刷题记"/></a><div class="content"><a class="title" href="/2021/11/14/CTF%E5%88%B7%E9%A2%98%E8%AE%B0/" title="CTF刷题记">CTF刷题记</a><time datetime="2021-11-14T04:43:35.000Z" title="发表于 2021-11-14 12:43:35">2021-11-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/10/16/BLOG%E6%90%AD%E5%BB%BA%E6%8C%87%E5%8D%97/" title="Blog搭建指南"><img src="/img/hexo.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Blog搭建指南"/></a><div class="content"><a class="title" href="/2021/10/16/BLOG%E6%90%AD%E5%BB%BA%E6%8C%87%E5%8D%97/" title="Blog搭建指南">Blog搭建指南</a><time datetime="2021-10-16T11:39:08.000Z" title="发表于 2021-10-16 19:39:08">2021-10-16</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By AndrewLee</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    loader: {
      source: {
        '[tex]/amsCd': '[tex]/amscd'
      }
    },
    tex: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]],
      tags: 'ams'
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, ''],
        addClass: [200,() => {
          document.querySelectorAll('mjx-container:not([display=\'true\']').forEach( node => {
            const target = node.parentNode
            if (!target.classList.contains('has-jax')) {
              target.classList.add('mathjax-overflow')
            }
          })
        }, '', false]
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typeset()
}</script></div><script src="https://cdn.jsdelivr.net/gh/sviptzk/HexoStaticFile@latest/Hexo/js/mouse_snow.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>